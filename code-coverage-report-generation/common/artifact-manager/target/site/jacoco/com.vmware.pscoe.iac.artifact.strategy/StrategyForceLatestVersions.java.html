<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>StrategyForceLatestVersions.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">artifact-manager</a> &gt; <a href="index.source.html" class="el_package">com.vmware.pscoe.iac.artifact.strategy</a> &gt; <span class="el_source">StrategyForceLatestVersions.java</span></div><h1>StrategyForceLatestVersions.java</h1><pre class="source lang-java linenums">package com.vmware.pscoe.iac.artifact.strategy;

/*
 * #%L
 * artifact-manager
 * %%
 * Copyright (C) 2023 VMware
 * %%
 * Build Tools for VMware Aria
 * Copyright 2023 VMware, Inc.
 * 
 * This product is licensed to you under the BSD-2 license (the &quot;License&quot;). You may not use this product except in compliance with the BSD-2 License.  
 * 
 * This product may include a number of subcomponents with separate copyright notices and license terms. Your use of these subcomponents is subject to the terms and conditions of the subcomponent's license, as noted in the LICENSE file.
 * #L%
 */

import java.util.Hashtable;
import java.util.List;
import java.util.stream.Collectors;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import com.vmware.pscoe.iac.artifact.model.Package;

/**
 * This strategy will only import a package if it's the same or newer version than the one in the Orchestrator server.
 * Snapshot versions are considered newer if they are the same version.
 */
<span class="nc" id="L31">public class StrategyForceLatestVersions extends StrategySkipOldVersions {</span>

	/**
	 * The class logger.
	 */
<span class="nc" id="L36">	private final Logger logger = LoggerFactory.getLogger(StrategyForceLatestVersions.class);</span>

	/**
	 * We filter the packages.
	 *
	 * Logic:
	 * - If the package is not present in the destination, we will import it.
	 * - If the package has a newer version, and we will import it (`diff` will be a positive value)
	 * - If the package has the same version, we will import it if it's a snapshot. (`diff` will be 0)
	 * - If the package has an older version, we will not import it. (`diff` will be a negative value)
	 *
	 * @param sourceEndpointPackages      The packages in the source endpoint.
	 * @param destinationEndpointPackages The packages in the destination endpoint.
	 * @return The packages that should be imported.
	 */
	public List&lt;Package&gt; filterHigherVersions(List&lt;Package&gt; sourceEndpointPackages,
			List&lt;Package&gt; destinationEndpointPackages) {
<span class="nc" id="L53">		Hashtable&lt;String, Package&gt; latestPackages = new Hashtable&lt;&gt;();</span>
<span class="nc" id="L54">		destinationEndpointPackages.forEach(aPackage -&gt; {</span>
<span class="nc" id="L55">			Package latest = latestPackages.get(aPackage.getName());</span>
<span class="nc bnc" id="L56" title="All 4 branches missed.">			if (latest == null || latest.compareTo(aPackage) &lt; 0) {</span>
<span class="nc" id="L57">				latestPackages.put(aPackage.getName(), aPackage);</span>
			}
<span class="nc" id="L59">		});</span>

<span class="nc" id="L61">		logger.info(&quot;STRATEGY| PASS | Source.Version &gt; Destination.Version&quot;);</span>
<span class="nc" id="L62">		List&lt;Package&gt; sourceEndpointPackagesHigerVersion = sourceEndpointPackages.stream().filter(sourcePackage -&gt; {</span>
<span class="nc" id="L63">			Package latest = latestPackages.get(sourcePackage.getName());</span>
<span class="nc bnc" id="L64" title="All 2 branches missed.">			if (latest != null) {</span>
<span class="nc" id="L65">				int diff = sourcePackage.compareTo(latest);</span>

<span class="nc bnc" id="L67" title="All 6 branches missed.">				if (diff &gt; 0 || diff == 0 &amp;&amp; latest.isSnapshot()) {</span>
<span class="nc" id="L68">					logInfoPackages(sourcePackage, latest, &quot;PASS&quot;, &quot;&gt;&quot;);</span>
<span class="nc" id="L69">					return true;</span>
<span class="nc bnc" id="L70" title="All 2 branches missed.">				} else if (diff == 0) {</span>
<span class="nc" id="L71">					return false;</span>
				} else {
<span class="nc" id="L73">					logInfoPackages(sourcePackage, latest, &quot;FAIL&quot;, &quot;&gt;&quot;);</span>
<span class="nc" id="L74">					throw new RuntimeException(</span>
<span class="nc" id="L75">							String.format(&quot;Package %s version %s is older than the one in the Orchestrator server %s&quot;,</span>
<span class="nc" id="L76">									sourcePackage.getName(),</span>
<span class="nc" id="L77">									sourcePackage.getVersion(), latest.getVersion()));</span>
				}
			}

<span class="nc" id="L81">			logInfoPackages(sourcePackage, latest, &quot;PASS&quot;, &quot;&gt;&quot;);</span>
<span class="nc" id="L82">			return true;</span>
<span class="nc" id="L83">		}).collect(Collectors.toList());</span>

<span class="nc" id="L85">		return sourceEndpointPackagesHigerVersion;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>