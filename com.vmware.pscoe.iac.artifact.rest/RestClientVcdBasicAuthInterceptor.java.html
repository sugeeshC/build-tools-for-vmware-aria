<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>RestClientVcdBasicAuthInterceptor.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">artifact-manager</a> &gt; <a href="index.source.html" class="el_package">com.vmware.pscoe.iac.artifact.rest</a> &gt; <span class="el_source">RestClientVcdBasicAuthInterceptor.java</span></div><h1>RestClientVcdBasicAuthInterceptor.java</h1><pre class="source lang-java linenums">package com.vmware.pscoe.iac.artifact.rest;

/*
 * #%L
 * artifact-manager
 * %%
 * Copyright (C) 2023 VMware
 * %%
 * Build Tools for VMware Aria
 * Copyright 2023 VMware, Inc.
 * 
 * This product is licensed to you under the BSD-2 license (the &quot;License&quot;). You may not use this product except in compliance with the BSD-2 License.  
 * 
 * This product may include a number of subcomponents with separate copyright notices and license terms. Your use of these subcomponents is subject to the terms and conditions of the subcomponent's license, as noted in the LICENSE file.
 * #L%
 */

import com.vmware.pscoe.iac.artifact.configuration.ConfigurationVcd;
import com.vmware.pscoe.iac.artifact.rest.helpers.VcdApiHelper;
import com.fasterxml.jackson.core.JsonProcessingException;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.http.HttpEntity;
import org.springframework.http.HttpHeaders;
import org.springframework.http.HttpMethod;
import org.springframework.http.HttpRequest;
import org.springframework.http.MediaType;
import org.springframework.http.ResponseEntity;
import org.springframework.http.client.ClientHttpRequestExecution;
import org.springframework.http.client.ClientHttpResponse;
import org.springframework.web.client.RestTemplate;
import org.springframework.web.util.UriComponentsBuilder;

import java.io.IOException;
import java.net.URI;
import java.util.ArrayList;
import java.util.List;

public class RestClientVcdBasicAuthInterceptor extends RestClientRequestInterceptor&lt;ConfigurationVcd&gt; {

	/**
	 * logger.
	 */
<span class="nc" id="L45">	private final Logger logger = LoggerFactory.getLogger(RestClientVcdBasicAuthInterceptor.class);</span>

	/**
	 * vcloudToken.
	 */
	private String vcloudToken;

	/**
	 * bearerToken.
	 */
	private String bearerToken;

	/**
	 * contentType.
	 */
	private MediaType contentType;

	/**
	 * Provider session api path.
	 */
	private static final String PROVIDER_URL_SESSION = &quot;/cloudapi/1.0.0/sessions/provider&quot;;
	
	/**
	 * version api path.
	 */
	private static final String URL_VERSION = &quot;/api/versions&quot;;

	/**
	 * vcloud header key.
	 */
	private static final String HEADER_VCLOUD_TOKEN = &quot;x-vcloud-authorization&quot;;

	/**
	 * bearer token header key.
	 */
	private static final String HEADER_BEARER_TOKEN = &quot;x-vmware-vcloud-access-token&quot;;

	/**
	 * authorization header key.
	 */
	private static final String HEADER_AUTHORIZATION = &quot;Authorization&quot;;

	/**
	 * api version that is supported.
	 */
	private static final String API_VERSION_37 = &quot;37.0&quot;;

	/**
	 * api version that is not yet supported.
	 */
	private static final String API_VERSION_38 = &quot;38.0&quot;;

	protected RestClientVcdBasicAuthInterceptor(ConfigurationVcd configuration, RestTemplate restTemplate,
			String apiVersion) {
<span class="nc" id="L99">		super(configuration, restTemplate);</span>
<span class="nc bnc" id="L100" title="All 2 branches missed.">		if (Double.parseDouble(apiVersion) &gt;= Double.parseDouble(API_VERSION_38)) {</span>
<span class="nc" id="L101">			logger.warn(&quot;Detected vCD API version equal or greater than &quot; + API_VERSION_38 + &quot;. Switching to using API version &quot; + API_VERSION_37);</span>
<span class="nc" id="L102">			apiVersion = API_VERSION_37;</span>
		}

<span class="nc" id="L105">		this.contentType = VcdApiHelper.buildMediaType(&quot;application/json&quot;, apiVersion);</span>
<span class="nc" id="L106">	}</span>

	/**
	 * Intercepts all requests done to the vCD API.
	 * 
	 * @param request Http request
	 * @param body body
	 * @param execution request execution
	 * @return ClientHttpResponse
	 */
	@Override
	public ClientHttpResponse intercept(HttpRequest request, byte[] body, ClientHttpRequestExecution execution) {
		try {
<span class="nc bnc" id="L119" title="All 4 branches missed.">			if (!request.getURI().getPath().contains(PROVIDER_URL_SESSION) &amp;&amp; !request.getURI().getPath().contains(URL_VERSION)) {</span>
<span class="nc bnc" id="L120" title="All 2 branches missed.">				if (this.bearerToken == null) {</span>
<span class="nc" id="L121">					logger.info(&quot;Aquiring vCD auth token...&quot;);</span>
<span class="nc" id="L122">					acquireToken(request);</span>
<span class="nc" id="L123">					logger.info(&quot;vCD auth token aquired&quot;);</span>
				}
				
<span class="nc" id="L126">				request.getHeaders().add(HEADER_VCLOUD_TOKEN, this.vcloudToken);</span>
<span class="nc" id="L127">				request.getHeaders().add(HEADER_AUTHORIZATION, VcdApiHelper.buildBearerToken(this.bearerToken));</span>
			}
			
<span class="nc" id="L130">			return execution.execute(request, body);</span>
<span class="nc" id="L131">		} catch (IOException e) {</span>
<span class="nc" id="L132">			throw new RuntimeException(e);</span>
		}
	}

	private void acquireToken(HttpRequest request) throws JsonProcessingException {
<span class="nc" id="L137">		final URI tokenUri = UriComponentsBuilder.newInstance().scheme(request.getURI().getScheme())</span>
<span class="nc" id="L138">				.host(request.getURI().getHost()).port(request.getURI().getPort()).path(PROVIDER_URL_SESSION).build().toUri();</span>

		// Prepare Headers
<span class="nc" id="L141">		final HttpHeaders headers = new HttpHeaders();</span>
<span class="nc" id="L142">		List&lt;MediaType&gt; acceptableMediaTypes = new ArrayList&lt;MediaType&gt;();</span>
<span class="nc" id="L143">		acceptableMediaTypes.add(contentType);</span>

<span class="nc" id="L145">		headers.setAccept(acceptableMediaTypes);</span>
<span class="nc" id="L146">		headers.add(HEADER_AUTHORIZATION, VcdApiHelper.buildBasicAuth(this.getConfiguration().getUsername(),</span>
<span class="nc" id="L147">				this.getConfiguration().getDomain(), this.getConfiguration().getPassword()));</span>
<span class="nc" id="L148">		final HttpEntity&lt;String&gt; entity = new HttpEntity&lt;&gt;(headers);</span>
		
<span class="nc" id="L150">		logger.warn(&quot;token uri: &quot; + tokenUri);</span>
<span class="nc" id="L151">		logger.warn(&quot;Auth: &quot; + VcdApiHelper.buildBasicAuth(this.getConfiguration().getUsername(),</span>
<span class="nc" id="L152">				this.getConfiguration().getDomain(), this.getConfiguration().getPassword()));</span>

<span class="nc" id="L154">		final ResponseEntity&lt;String&gt; response = getRestTemplate().exchange(tokenUri, HttpMethod.POST, entity,</span>
				String.class);
<span class="nc bnc" id="L156" title="All 2 branches missed.">		this.vcloudToken = response.getHeaders().get(HEADER_VCLOUD_TOKEN) == null ? null : response.getHeaders().get(HEADER_VCLOUD_TOKEN).get(0); </span>
<span class="nc" id="L157">		this.bearerToken = response.getHeaders().get(HEADER_BEARER_TOKEN).get(0);</span>
<span class="nc" id="L158">	}</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>