<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>VraPackageStore.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">artifact-manager</a> &gt; <a href="index.source.html" class="el_package">com.vmware.pscoe.iac.artifact</a> &gt; <span class="el_source">VraPackageStore.java</span></div><h1>VraPackageStore.java</h1><pre class="source lang-java linenums">package com.vmware.pscoe.iac.artifact;

/*
 * #%L
 * artifact-manager
 * %%
 * Copyright (C) 2023 VMware
 * %%
 * Build Tools for VMware Aria
 * Copyright 2023 VMware, Inc.
 * 
 * This product is licensed to you under the BSD-2 license (the &quot;License&quot;). You may not use this product except in compliance with the BSD-2 License.  
 * 
 * This product may include a number of subcomponents with separate copyright notices and license terms. Your use of these subcomponents is subject to the terms and conditions of the subcomponent's license, as noted in the LICENSE file.
 * #L%
 */

import java.io.File;
import java.io.IOException;
import java.net.URISyntaxException;
import java.util.ArrayList;
import java.util.List;
import java.util.stream.Collectors;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import com.vmware.pscoe.iac.artifact.extentions.PackageStoreExtention;
import com.vmware.pscoe.iac.artifact.model.Package;
import com.vmware.pscoe.iac.artifact.model.PackageContent.Content;
import com.vmware.pscoe.iac.artifact.model.Version;
import com.vmware.pscoe.iac.artifact.model.vra.VraPackageContent;
import com.vmware.pscoe.iac.artifact.model.vra.VraPackageDescriptor;
import com.vmware.pscoe.iac.artifact.rest.RestClientVra;
import com.vmware.pscoe.iac.artifact.strategy.Strategy;

public class VraPackageStore extends GenericPackageStore&lt;VraPackageDescriptor&gt; {
	/**
	 * Variable for logging.
	 */
<span class="nc" id="L41">	private final Logger logger = LoggerFactory.getLogger(VraPackageStore.class);</span>

	/**
	 * The vRA rest client.
	 */
	private final RestClientVra restClient;

	/**
	 * The vRA package store strategies.
	 */
	private final List&lt;Strategy&gt; strategies;

	/**
	 * The vRA package store extensions.
	 */
	private final List&lt;PackageStoreExtention&lt;VraPackageDescriptor&gt;&gt; extentions;

	/**
	 *
	 * @param vraRestClient the vRA rest client
	 * @param vraStrategies the vRA strategies
	 * @param vraExtentions the vRA extensions
	 */
<span class="nc" id="L64">	protected VraPackageStore(final RestClientVra vraRestClient, final List&lt;Strategy&gt; vraStrategies, final List&lt;PackageStoreExtention&lt;VraPackageDescriptor&gt;&gt; vraExtentions) {</span>
<span class="nc" id="L65">		this.restClient = vraRestClient;</span>
<span class="nc" id="L66">		this.strategies = vraStrategies;</span>
<span class="nc" id="L67">		this.extentions = vraExtentions;</span>
<span class="nc" id="L68">	}</span>

	/**
	 *
	 * @param vraRestClient the vRA rest client
	 * @param vraStrategies the vRA strategies
	 * @param vraExtentions the vRA extensions
	 * @param vraProductVersion the vRA product version
	 */
<span class="nc" id="L77">    protected VraPackageStore(final RestClientVra vraRestClient, final List&lt;Strategy&gt; vraStrategies, final List&lt;PackageStoreExtention&lt;VraPackageDescriptor&gt;&gt; vraExtentions, final Version vraProductVersion) {</span>
<span class="nc" id="L78">        this.restClient = vraRestClient;</span>
<span class="nc" id="L79">        this.strategies = vraStrategies;</span>
<span class="nc" id="L80">        this.extentions = vraExtentions;</span>
<span class="nc" id="L81">        super.setProductVersion(vraProductVersion);</span>
<span class="nc" id="L82">    }</span>

	/**
	 * Gets the packages.
	 * @return the extracted vRA packages
	 */
	@Override
	public List&lt;Package&gt; getPackages() {
<span class="nc" id="L90">		List&lt;Package&gt; pkgs = restClient.getPackages();</span>
<span class="nc bnc" id="L91" title="All 2 branches missed.">		for (Package pkg : pkgs) {</span>
<span class="nc" id="L92">			logger.info(String.format(PackageStore.PACKAGE_LIST, pkg));</span>
<span class="nc" id="L93">		}</span>
<span class="nc" id="L94">		return pkgs;</span>
	}

	/**
	 * Exports all packages.
	 * @param vraPackages the packages to export
	 * @param dryrun whether it should be dry run
	 * @return the exported packages
	 */
	@Override
	public final List&lt;Package&gt; exportAllPackages(final List&lt;Package&gt; vraPackages, final boolean dryrun) {
<span class="nc" id="L105">		this.vlidateServer(vraPackages);</span>

<span class="nc" id="L107">		List&lt;Package&gt; sourceEndpointPackages = vraPackages;</span>
<span class="nc" id="L108">		List&lt;Package&gt; destinationEndpointPackages = vraPackages.stream()</span>
<span class="nc" id="L109">				.filter(pkg -&gt; new File(pkg.getFilesystemPath()).exists()).collect(Collectors.toList());</span>
<span class="nc bnc" id="L110" title="All 2 branches missed.">		for (Strategy strategy : strategies) {</span>
<span class="nc" id="L111">			sourceEndpointPackages = strategy.getExportPackages(sourceEndpointPackages, destinationEndpointPackages);</span>
<span class="nc" id="L112">		}</span>

<span class="nc bnc" id="L114" title="All 2 branches missed.">		if (sourceEndpointPackages.isEmpty()) {</span>
<span class="nc" id="L115">			return new ArrayList&lt;&gt;();</span>
		}

<span class="nc" id="L118">		List&lt;Package&gt; exportedPackages = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L119" title="All 2 branches missed.">		for (Package pkg : vraPackages) {</span>
<span class="nc" id="L120">			VraPackageDescriptor vraPackageDescriptor = VraPackageDescriptor.getInstance(new File(pkg.getFilesystemPath()));</span>
<span class="nc" id="L121">			exportedPackages.add(this.exportPackage(pkg, vraPackageDescriptor, dryrun));</span>
<span class="nc" id="L122">		}</span>

<span class="nc" id="L124">		return exportedPackages;</span>
	}

	/**
	 * Imports all packages.
	 * @param pkg the packages to import
	 * @param dryrun whether it should be dry run
	 * @param enableBackup whether it should back up the packages on import
	 * @return the imported packages
	 */
	@Override
	public final List&lt;Package&gt; importAllPackages(final List&lt;Package&gt; pkg, final boolean dryrun, final boolean enableBackup) {
<span class="nc" id="L136">		return this.importAllPackages(pkg, dryrun, false, enableBackup);</span>
	}

	/**
	 * Imports all packages.
	 * @param vraPackages the packages to import
	 * @param dryrun whether it should be dry run
	 * @param mergePackages whether to merge the packages
	 * @param enableBackup whether it should back up the packages on import
	 * @return the imported packages
	 */
	@Override
	public final List&lt;Package&gt; importAllPackages(final List&lt;Package&gt; vraPackages, final boolean dryrun, final boolean mergePackages, final boolean enableBackup) {
<span class="nc" id="L149">		this.validateFilesystem(vraPackages);</span>

<span class="nc" id="L151">		List&lt;Package&gt; sourceEndpointPackages = vraPackages;</span>
<span class="nc" id="L152">		List&lt;Package&gt; destinationEndpointPackages = restClient.getPackages();</span>
<span class="nc bnc" id="L153" title="All 2 branches missed.">		for (Strategy strategy : strategies) {</span>
<span class="nc" id="L154">			sourceEndpointPackages = strategy.getImportPackages(sourceEndpointPackages, destinationEndpointPackages);</span>
<span class="nc" id="L155">		}</span>

<span class="nc bnc" id="L157" title="All 2 branches missed.">		if (sourceEndpointPackages.isEmpty()) {</span>
<span class="nc" id="L158">			return new ArrayList&lt;&gt;();</span>
		}

<span class="nc" id="L161">		List&lt;Package&gt; importedPackages = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L162" title="All 2 branches missed.">		for (Package pkg : sourceEndpointPackages) {</span>
<span class="nc" id="L163">			importedPackages.add(this.importPackage(pkg, dryrun, mergePackages));</span>
<span class="nc" id="L164">		}</span>

<span class="nc" id="L166">		return importedPackages;</span>
	}

	/**
	 * Exports a package.
	 * @param vraPackage the package to export
	 * @param dryrun whether it should be a dry run
	 * @return the exported package
	 */
	@Override
	public final Package exportPackage(final Package vraPackage, final boolean dryrun) {
<span class="nc" id="L177">		logger.info(String.format(PackageStore.PACKAGE_EXPORT, vraPackage));</span>
<span class="nc" id="L178">		Package pkg = restClient.exportPackage(vraPackage, dryrun);</span>
<span class="nc bnc" id="L179" title="All 2 branches missed.">		for (PackageStoreExtention&lt;VraPackageDescriptor&gt; e : extentions) {</span>
<span class="nc" id="L180">		    e.exportPackage(pkg, null, dryrun);</span>
<span class="nc" id="L181">		}</span>

<span class="nc" id="L183">		return pkg;</span>
	}

	/**
	 * Exports a package.
	 * @param vraPackage the package to export
	 * @param vraPackageDescriptor the package descriptor
	 * @param dryrun whether it should be dry run
	 * @return the exported package
	 */
	@Override
	public final Package exportPackage(final Package vraPackage, final VraPackageDescriptor vraPackageDescriptor, final boolean dryrun) {
<span class="nc" id="L195">		logger.info(String.format(PackageStore.PACKAGE_EXPORT, vraPackage));</span>
<span class="nc" id="L196">		Package resultVraPackage = vraPackage;</span>

<span class="nc bnc" id="L198" title="All 2 branches missed.">		if (vraPackageDescriptor.hasNativeContent()) {</span>
<span class="nc" id="L199">			resultVraPackage = restClient.exportPackage(resultVraPackage, dryrun);</span>
		}

<span class="nc bnc" id="L202" title="All 2 branches missed.">		for (PackageStoreExtention&lt;VraPackageDescriptor&gt; e : extentions) {</span>
<span class="nc" id="L203">		    e.exportPackage(resultVraPackage, vraPackageDescriptor, dryrun);</span>
<span class="nc" id="L204">		}</span>

<span class="nc" id="L206">		return resultVraPackage;</span>
	}

	/**
	 * Imports a package.
	 * @param vraPackage the package to import
	 * @param dryrun whether it should be dry run
	 * @param mergePackages whether to merge the packages
	 * @return the imported package
	 */
	@Override
	public final Package importPackage(final Package vraPackage, final boolean dryrun, final boolean mergePackages) {
<span class="nc" id="L218">		logger.info(String.format(PackageStore.PACKAGE_IMPORT, vraPackage));</span>
<span class="nc" id="L219">		Package resultVraPackage = vraPackage;</span>

		boolean hasNativeContent;
		try {
<span class="nc" id="L223">			hasNativeContent = new PackageManager(resultVraPackage).getAllFiles().stream().anyMatch(f -&gt; f.equals(&quot;metadata.yaml&quot;));</span>
<span class="nc" id="L224">		} catch (IOException e) {</span>
<span class="nc" id="L225">			throw new RuntimeException(e);</span>
<span class="nc" id="L226">		}</span>
		
<span class="nc bnc" id="L228" title="All 2 branches missed.">		if (hasNativeContent) {</span>
<span class="nc" id="L229">			resultVraPackage = restClient.importPackage(resultVraPackage, dryrun);</span>
		}

<span class="nc bnc" id="L232" title="All 2 branches missed.">		for (PackageStoreExtention&lt;VraPackageDescriptor&gt; e : extentions) {</span>
<span class="nc" id="L233">            e.importPackage(resultVraPackage, dryrun);</span>
<span class="nc" id="L234">        }</span>

<span class="nc" id="L236">        return resultVraPackage;</span>
	}

	/**
	 * Exports a package.
	 * @param vraPackage the package to export
	 * @param vraPackageDescriptorFile the descriptor of the package to export
	 * @param dryrun whether it should be dry run
	 * @return exported package
	 */
	@Override
	public final Package exportPackage(final Package vraPackage, final File vraPackageDescriptorFile, final boolean dryrun) {
<span class="nc" id="L248">		VraPackageDescriptor vraPackageDescriptor = VraPackageDescriptor.getInstance(vraPackageDescriptorFile);</span>
<span class="nc bnc" id="L249" title="All 2 branches missed.">		if (vraPackageDescriptor.hasNativeContent()) {</span>
			try {
<span class="nc" id="L251">				restClient.createPackage(vraPackage, vraPackageDescriptor);</span>
<span class="nc" id="L252">			} catch (URISyntaxException e) {</span>
<span class="nc" id="L253">				throw new RuntimeException(&quot;Cannot create vRA package with provided descriptor.&quot;, e);</span>
<span class="nc" id="L254">			}</span>
		}

<span class="nc" id="L257">		return this.exportPackage(vraPackage, vraPackageDescriptor, dryrun);</span>
	}

	/**
	 * Deletes a package.
	 * @param pkg the package to delete
	 * @param withContent whether to delete the package with its content
	 * @param dryrun whether it should be dry run
	 * @return the deleted package
	 */
	@Override
    protected Package deletePackage(final Package pkg, final boolean withContent, final boolean dryrun) {
<span class="nc" id="L269">        return restClient.deletePackage(pkg, withContent, dryrun);</span>
    }

	/**
	 * Gets the vRA package content.
	 * @param pkg the package which content to get
	 * @return the package content
	 */
	@Override
    protected final VraPackageContent getPackageContent(final Package pkg) {
<span class="nc" id="L279">        return restClient.getPackageContentPrimitive(pkg);</span>
    }

	/**
	 * Deletes conent.
	 * @param content the conent to delete
	 * @param dryrun whether it should be dry run
	 */
	@Override
    protected final void deleteContent(final Content content, final boolean dryrun) {
<span class="nc" id="L289">        restClient.deleteContentPrimitive(content, dryrun);</span>
<span class="nc" id="L290">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>